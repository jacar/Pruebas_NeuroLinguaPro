<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroLingua Elite | AI Cognitive Immersion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Outfit:wght@700;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --neural-purple: #78559b;
            --neural-purple-dark: #634483;
            --neural-gold: #fbbf24;
            --accent-indigo: #6366f1;
            --bg-slate: #0f172a;
            --brand-primary: #78559b;
            --brand-secondary: #a855f7;
            --brand-light: #f8fafc;
            --brand-text: #1e293b;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #ffffff;
            color: var(--brand-text);
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        h1,
        h2,
        h3,
        .font-display {
            font-family: 'Outfit', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #cbd5e1;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.05);
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .hero-gradient {
            background: radial-gradient(circle at 10% 20%, rgba(120, 85, 155, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(99, 102, 241, 0.05) 0%, transparent 50%);
        }

        .text-gradient {
            background: linear-gradient(135deg, #1e293b 0%, #78559b 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .animate-float {
            animation: float 6s ease-in-out infinite;
        }

        /* GALLERY AUTO-SLIDE */
        .hero-gallery {
            position: relative;
            width: 100%;
            height: 60vh;
            /* Make it responsive to viewport height */
            min-height: 300px;
            /* Minimum height for smaller screens */
            max-height: 500px;
            /* Maximum height for larger screens */
            border-radius: 3rem;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
        }

        .gallery-slide {
            position: absolute;
            inset: 0;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            background-size: cover;
            background-position: center;
        }

        .gallery-slide.active {
            opacity: 1;
        }

        .gallery-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, transparent 40%, rgba(15, 23, 42, 0.6) 100%);
        }

        .btn-elite {
            position: relative;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .btn-elite:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(120, 85, 155, 0.3);
        }

        /* Markdown Styling */
        .markdown-body b,
        .markdown-body strong {
            font-weight: 800;
            color: #78559b;
        }

        .markdown-body i,
        .markdown-body em {
            font-style: italic;
            color: #6366f1;
        }

        .markdown-body p {
            margin-bottom: 0.5rem;
        }

        /* Loader */
        .custom-loader {
            width: 20px;
            height: 20px;
            border: 3px solid #78559b;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Toggle Switch Styling */
        input:checked+.block {
            background-color: #78559b;
        }

        input:checked+.block .dot {
            transform: translateX(100%);
        }

        /* HIDE VERCEL TOOLBAR */
        vercel-live-feedback,
        #vercel-toolbar,
        [data-testid="vercel-toolbar"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }
    </style>
</head>

<body class="bg-white text-slate-800 font-sans selection:bg-[#78559b]/10 selection:text-[#78559b] hero-gradient">

    <!-- NAVIGATION ELITE (GLASS) -->
    <nav class="fixed top-0 w-full z-[1000] glass-nav transition-all duration-500">
        <div class="container mx-auto px-4 md:px-8 h-20 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <img src="https://www.webcincodev.com/blog/wp-content/uploads/2025/12/Diseno-sin-titulo-1.png"
                    class="h-10 w-auto">
                <div>
                    <h1 class="text-xl font-black tracking-tighter italic leading-none">NeuroLingua<span
                            class="text-[#78559b]">.</span></h1>
                    <span class="text-xs md:text-[8px] font-black uppercase tracking-[0.3em] text-slate-400">Elite
                        Cognitive
                        v5.2</span>
                </div>
            </div>

            <div class="hidden md:flex items-center gap-10">
                <a href="#how-it-works"
                    class="text-[10px] font-black uppercase tracking-widest text-slate-500 hover:text-[#78559b] transition-colors">Protocolo</a>
                <button id="navAuthBtn" onclick="openApiModal('login')"
                    class="text-[10px] font-black uppercase tracking-widest text-slate-500 hover:text-[#78559b] transition-colors px-4 py-2">Iniciar
                    Sesión</button>
                <a href="#app-section"
                    class="btn-elite bg-slate-900 px-8 py-3.5 rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] text-white">Panel
                    de Control</a>
            </div>

            <!-- Mobile Menu Button -->
            <div class="md:hidden flex items-center">
                <button id="mobile-menu-button" class="text-slate-500 focus:outline-none p-4">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu (Hidden by default) -->
    <div id="mobile-menu"
        class="hidden md:hidden fixed top-20 w-full bg-white shadow-lg z-[999] py-4 animate-in slide-in-from-top duration-300">
        <div class="container mx-auto px-4 space-y-4">
            <a href="#how-it-works"
                class="block text-base font-medium text-slate-700 hover:text-[#78559b] transition-colors py-2">Protocolo</a>
            <button onclick="openApiModal('login')"
                class="block text-base font-medium text-slate-700 hover:text-[#78559b] transition-colors py-3 w-full text-left">Iniciar
                Sesión</button>
            <a href="#app-section"
                class="block btn-elite bg-[#78559b] px-6 py-3 rounded-xl text-white font-black uppercase text-sm tracking-widest text-center">Panel
                de Control</a>
        </div>
    </div>

    <!-- HERO SECTION -->
    <header class="pt-24 pb-12 md:pt-40 md:pb-20 relative px-4">
        <div class="container mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 md:gap-20 items-center">
                <div class="space-y-10">
                    <div
                        class="inline-flex items-center gap-3 bg-[#78559b]/5 border border-[#78559b]/20 px-4 py-2 rounded-full">
                        <span class="w-2 h-2 rounded-full bg-[#78559b] animate-ping"></span>
                        <span
                            class="text-xs md:text-[9px] font-black uppercase tracking-[0.2em] text-[#78559b]">Sincronización
                            AI
                            Activa</span>
                    </div>

                    <h1
                        class="text-5xl md:text-7xl xl:text-8xl font-black tracking-tighter leading-[0.9] text-slate-900 italic">
                        Inmersión<br>
                        <span class="text-gradient">Total.</span>
                    </h1>

                    <p class="text-base md:text-xl text-slate-500 max-w-lg leading-relaxed font-medium">
                        Entrena tu cerebro para pensar en inglés mediante simulaciones neurales de alta fidelidad. <span
                            class="text-slate-900 font-bold">Sin gramática aburrida, solo puro instinto.</span>
                    </p>

                    <div class="flex flex-wrap gap-6 items-center">
                        <a href="#app-section"
                            class="btn-elite bg-[#78559b] px-10 py-5 rounded-[2rem] text-white font-black uppercase text-[11px] tracking-widest flex items-center gap-4">
                            Comenzar Sesión <i class="fa-solid fa-arrow-right"></i>
                        </a>
                        <div class="flex -space-x-3">
                            <div class="w-10 h-10 rounded-full border-2 border-white bg-slate-200"></div>
                            <div class="w-10 h-10 rounded-full border-2 border-white bg-slate-300"></div>
                            <div class="w-10 h-10 rounded-full border-2 border-white bg-slate-400"></div>
                            <div
                                class="flex items-center pl-6 text-[10px] font-black text-slate-400 tracking-widest uppercase">
                                +500 Alumnos Elite</div>
                        </div>
                    </div>
                </div>

                <div class="relative">
                    <div class="hero-gallery animate-float">
                        <div class="gallery-slide active" style="background-image: url('assets/img/hero1.png')"></div>
                        <div class="gallery-slide" style="background-image: url('assets/img/hero2.png')"></div>
                        <div class="gallery-overlay"></div>
                    </div>

                    <!-- FLOAT CARDS -->
                    <div
                        class="glass-card absolute -bottom-10 -left-10 p-6 rounded-3xl shadow-2xl border-white/50 max-w-[200px] animate-in slide-in-from-left duration-1000 delay-500 hidden md:block">
                        <div class="flex items-center gap-3 mb-3">
                            <i class="fa-solid fa-bolt text-amber-400"></i>
                            <span
                                class="text-xs md:text-[9px] font-black uppercase tracking-widest text-slate-500">Precisión</span>
                        </div>
                        <div class="text-2xl font-black italic text-slate-900">98.4%</div>
                        <div class="h-1.5 w-full bg-slate-100 rounded-full mt-3 overflow-hidden">
                            <div class="h-full bg-amber-400 rounded-full w-[98%]"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <!-- WARNING BANNER FOR LOCAL FILE PROTOCOL -->
    <div id="protocol-warning"
        class="hidden fixed top-24 left-1/2 -translate-x-1/2 z-[500] w-[90%] max-w-xl bg-rose-50 border border-rose-200 p-4 rounded-2xl shadow-xl animate-in slide-in-from-top duration-500">
        <div class="flex items-center gap-4 text-rose-800">
            <i class="fa-solid fa-circle-exclamation text-xl"></i>
            <div class="text-[11px] font-medium leading-relaxed">
                <p class="font-black uppercase tracking-widest text-[9px] mb-1">Error de Protocolo Detectado</p>
                Estas ejecutando desde <code class="bg-rose-100 px-1 rounded">file://</code>. El sistema neural requiere
                un servidor local para funcionar.
                <br>Corre <span class="font-bold underline">npm start</span> o <span class="font-bold underline">npx
                    serve .</span> y entra a <span class="font-bold">http://localhost:3000</span>.
            </div>
            <button onclick="this.parentElement.parentElement.remove()"
                class="ml-auto text-rose-400 hover:text-rose-600 p-3"><i class="fa-solid fa-xmark"></i></button>
        </div>
    </div>

    <!-- MODAL DE API KEYS -->
    <div id="apiModal"
        class="fixed inset-0 z-[600] hidden flex items-center justify-center p-6 bg-slate-900/40 backdrop-blur-sm">
        <div
            class="modal-blur p-6 md:p-10 rounded-[2.5rem] max-w-md w-full shadow-2xl space-y-8 animate-in zoom-in duration-300">
            <div class="text-center">
                <div
                    class="w-16 h-16 bg-[#78559b]/10 rounded-2xl flex items-center justify-center text-[#78559b] mx-auto mb-6">
                    <i class="fa-solid fa-user-lock text-2xl"></i>
                </div>
                <h3 class="text-2xl font-black italic text-slate-900">Acceso al Aula Elite</h3>
                <p class="text-xs text-slate-500 font-medium mt-2">Agrega tus accesos que recibiste del admin para
                    entrar.</p>
            </div>
            <div class="space-y-4">
                <div class="space-y-2">
                    <label class="text-[9px] font-black uppercase tracking-widest text-slate-400 ml-2">Código de Acceso
                        A</label>
                    <input type="password" id="groqKeyInput" placeholder="••••••••••••"
                        class="w-full bg-white/50 border border-slate-200 rounded-2xl px-5 py-3.5 text-sm focus:ring-2 focus:ring-[#78559b]/20 outline-none transition-all">
                </div>
                <div class="space-y-2">
                    <label class="text-[9px] font-black uppercase tracking-widest text-slate-400 ml-2">Código de Acceso
                        B</label>
                    <input type="password" id="cerebrasKeyInput" placeholder="••••••••••••"
                        class="w-full bg-white/50 border border-slate-200 rounded-2xl px-5 py-3.5 text-sm focus:ring-2 focus:ring-[#78559b]/20 outline-none transition-all">
                </div>
            </div>
            <button onclick="saveApiKeys()"
                class="w-full py-4 bg-[#78559b] text-white font-black rounded-2xl hover:bg-slate-800 transition-all shadow-lg shadow-[#78559b]/20 uppercase tracking-widest text-[10px]">
                Validar Accesos
            </button>
            <button onclick="closeApiModal()"
                class="w-full text-[9px] font-bold text-slate-400 uppercase tracking-widest hover:text-slate-600 transition-colors py-2 px-4">Configurar
                después</button>
        </div>
    </div>


    <!-- GUÍA DE USO DETALLADA -->
    <section id="how-it-works" class="py-12 md:py-24 bg-slate-50 relative overflow-hidden">
        <div class="container mx-auto px-4 relative z-10">
            <div class="text-center max-w-2xl mx-auto mb-10 md:mb-20">
                <span
                    class="text-[#78559b] text-xs md:text-[9px] font-black uppercase tracking-[0.4em] mb-4 block">Primeros
                    Pasos</span>
                <h2 class="text-4xl font-black text-slate-900 tracking-tighter mb-4 italic">Cómo Activar tu Neurona</h2>
                <p class="text-slate-500 font-medium leading-relaxed">Sigue este protocolo para maximizar tu inmersión
                    cognitiva.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-12">
                <div class="space-y-6">
                    <div
                        class="w-12 h-12 bg-[#78559b] text-white rounded-2xl flex items-center justify-center font-black shadow-lg shadow-[#78559b]/20">
                        1</div>
                    <h3 class="font-black text-xl text-slate-900 italic">Inicio de Sesión</h3>
                    <p class="text-slate-500 text-sm leading-relaxed">Haz clic en <b>Iniciar Sesión</b> e ingresa los
                        accesos que recibiste del administrador para activar tu sesión.</p>
                </div>
                <div class="space-y-6">
                    <div
                        class="w-12 h-12 bg-slate-800 text-white rounded-2xl flex items-center justify-center font-black shadow-lg">
                        2</div>
                    <h3 class="font-black text-xl text-slate-900 italic">Selección de Nivel</h3>
                    <p class="text-slate-500 text-sm leading-relaxed">Elige uno de los <b>49 módulos</b>. Cada uno es un
                        escenario único diseñado para entrenar áreas específicas de tu capacidad lingüística.</p>
                </div>
                <div class="space-y-6">
                    <div
                        class="w-12 h-12 bg-indigo-500 text-white rounded-2xl flex items-center justify-center font-black shadow-lg shadow-indigo-500/20">
                        3</div>
                    <h3 class="font-black text-xl text-slate-900 italic">Interacción y Feedback</h3>
                    <p class="text-slate-500 text-sm leading-relaxed">Habla o escribe. La IA corregirá tus errores en
                        <b>tiempo real</b> y te proporcionará traducciones dinámicas para cada respuesta.
                    </p>
                </div>
            </div>

            <!-- Sección Extra: Misión IA vs Escena -->
            <div
                class="mt-12 p-6 lg:mt-24 lg:p-12 bg-white rounded-[3rem] border border-slate-100 shadow-sm grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
                <div>
                    <h3 class="text-2xl font-black text-slate-900 mb-6 italic">¿Qué es la Misión IA?</h3>
                    <ul class="space-y-4">
                        <li class="flex gap-4 items-start">
                            <i class="fa-solid fa-circle-check text-emerald-500 mt-1"></i>
                            <p class="text-sm text-slate-600"><b>Misión IA:</b> Genera un objetivo específico para tu
                                conversación actual (ej: "Convence al recepcionista de una rebaja").</p>
                        </li>
                        <li class="flex gap-4 items-start">
                            <i class="fa-solid fa-circle-check text-emerald-500 mt-1"></i>
                            <p class="text-sm text-slate-600"><b>Escena Personalizada:</b> Tú describes el escenario y
                                la IA se adapta instantáneamente a tu petición.</p>
                        </li>
                    </ul>
                </div>
                <div class="bg-slate-50 p-8 rounded-[2rem] border border-slate-100">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-2 h-2 rounded-full bg-rose-500 animate-pulse"></div>
                        <span class="text-xs md:text-[9px] font-black uppercase tracking-widest text-slate-400">Pro Tip
                            de
                            Inmersión</span>
                    </div>
                    <p class="text-xs text-slate-500 leading-relaxed italic">"Usa el botón de micrófono para practicar
                        tu pronunciación. La IA analizará la fonética y te dará insights gramaticales basados en lo que
                        escucha."</p>
                </div>
            </div>
        </div>
    </section>

    <!-- DASHBOARD -->
    <section id="app-section" class="min-h-screen py-12 md:py-24 bg-white">
        <div class="container mx-auto px-4">
            <div class="mb-8 md:mb-16 flex flex-col md:flex-row justify-between items-end gap-6">
                <div>
                    <h2 class="text-4xl font-black text-slate-900 tracking-tighter italic">Tu Progreso <span
                            class="text-[#78559b]">Académico</span></h2>
                    <p class="text-slate-400 font-bold uppercase tracking-[0.4em] text-[9px] mt-3 italic">Módulos de
                        Inmersión Desbloqueados</p>
                </div>
                <div class="px-6 py-3 rounded-2xl bg-slate-50 border border-slate-100 flex items-center gap-4">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Sincronización</span>
                    <div class="w-32 h-2 bg-slate-200 rounded-full overflow-hidden">
                        <div class="w-1/3 h-full bg-[#78559b]"></div>
                    </div>
                    <span class="text-[10px] font-black text-[#78559b]">34%</span>
                </div>
            </div>
            <!-- Local Storage Info Block -->
            <div class="mb-12 flex items-center gap-3 bg-amber-50 border border-amber-100 p-4 rounded-xl max-w-fit">
                <i class="fa-solid fa-database text-amber-500 text-xs"></i>
                <p class="text-[10px] font-medium text-amber-700">Tu progreso se guarda automáticamente en este
                    dispositivo. <strong>No borres las cookies</strong> para mantener tu avance.</p>
            </div>
            <!-- LAB DE ESCENARIOS (NEW SECTION) -->
            <div id="customLabSection"
                class="mb-20 glass-card p-6 rounded-[3rem] border-2 border-slate-100 bg-slate-50/50">
                <div class="flex flex-col lg:flex-row gap-10 items-center">
                    <div class="flex-1 space-y-4">
                        <div class="inline-flex items-center gap-2 bg-[#78559b]/10 px-3 py-1.5 rounded-full">
                            <i class="fa-solid fa-flask-vial text-[#78559b] text-[10px]"></i>
                            <span class="text-[9px] font-black uppercase tracking-widest text-[#78559b]">Módulo
                                Experimental</span>
                        </div>
                        <h3 class="text-3xl font-black text-slate-900 italic tracking-tighter">Laboratorio de
                            Escenarios Neurales</h3>
                        <p class="text-slate-500 text-sm font-medium">Define tu propio entorno de entrenamiento. El
                            simulador se adaptará a cualquier situación que describas.</p>
                    </div>
                    <div class="w-full lg:w-1/2 flex flex-col lg:flex-row gap-4">
                        <input type="text" id="customSceneInput"
                            placeholder="Ej: Entrevista en Google, Pedir café en Paris..."
                            class="flex-1 w-full bg-white border border-slate-200 rounded-2xl px-6 py-4 text-sm focus:ring-2 focus:ring-[#78559b]/20 outline-none transition-all shadow-sm">
                        <button onclick="startCustomLab()"
                            class="w-full bg-slate-900 text-white px-8 py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-[#78559b] transition-all shadow-lg active:scale-95">
                            Generar Inmersión
                        </button>
                    </div>
                </div>
                <div class="mt-6 pt-6 border-t border-slate-200/50">
                    <h4 class="text-[10px] font-black uppercase tracking-widest text-[#78559b] mb-2">Modo Corrección
                    </h4>
                    <label for="correction-mode-toggle" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="correction-mode-toggle" class="sr-only">
                            <div class="block bg-gray-300 w-14 h-8 rounded-full"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                        </div>
                        <div class="ml-3 text-gray-700 font-medium">
                            Activar sugerencias de estilo y vocabulario
                        </div>
                    </label>
                </div>
                <!-- Scene Gen Explanation -->
                <div class="mt-6 pt-6 border-t border-slate-200/50">
                    <h4 class="text-[10px] font-black uppercase tracking-widest text-[#78559b] mb-2">¿Por qué usar esto?
                        (Apprende a TU Ritmo)</h4>
                    <p class="text-xs text-slate-500 leading-relaxed">
                        A diferencia de otras plataformas con rutas estáticas, aquí <strong>TÚ tienes el
                            control</strong>. Si tienes una entrevista mañana o un viaje la próxima semana, no esperes
                        al nivel 50. Escribe tu escenario arriba y la IA generará una lección <em>just-in-time</em>
                        adaptada a tu necesidad inmediata.
                    </p>
                </div>
            </div>

            <!-- Level Carousel Container -->
            <div id="levelsGrid"
                class="flex overflow-x-auto snap-x snap-mandatory gap-6 pb-8 custom-scrollbar-horizontal scroll-smooth px-2">
            </div>
        </div>
    </section>

    <!-- FOOTER -->
    <footer class="bg-slate-900 text-slate-400 py-20 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-64 h-64 bg-[#78559b]/10 blur-[100px] rounded-full"></div>
        <div class="container mx-auto px-6 relative z-10">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-12 mb-16">
                <div class="col-span-1 md:col-span-2">
                    <div class="flex items-center gap-3 mb-8">
                        <img src="https://www.webcincodev.com/blog/wp-content/uploads/2025/12/Diseno-sin-titulo-1.png"
                            class="h-10 w-auto brightness-0 invert">
                        <span class="text-xl font-black text-white italic tracking-tighter">NeuroLingua<span
                                class="text-[#78559b]">.</span></span>
                    </div>
                    <p class="text-sm max-w-sm leading-relaxed text-slate-400">
                        Plataforma de élite para la adquisición del inglés mediante IA. Sincroniza tu capacidad
                        cognitiva con el idioma global.
                    </p>
                </div>
                <div>
                    <h4 class="text-white font-bold text-xs uppercase tracking-widest mb-8">Políticas</h4>
                    <ul class="text-sm space-y-4">
                        <li><a href="javascript:void(0)" onclick="showPolicy('privacy')"
                                class="hover:text-white transition-colors">Privacidad</a></li>
                        <li><a href="javascript:void(0)" onclick="showPolicy('terms')"
                                class="hover:text-white transition-colors">Términos</a></li>
                        <li><a href="javascript:void(0)" onclick="showPolicy('cookies')"
                                class="hover:text-white transition-colors">Cookies</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-white font-bold text-xs uppercase tracking-widest mb-8">Soporte</h4>
                    <ul class="text-sm space-y-4">
                        <li><a href="javascript:void(0)" onclick="showPolicy('help')"
                                class="hover:text-white transition-colors">Centro de Ayuda</a></li>
                        <li><a href="javascript:void(0)" onclick="showPolicy('faq')"
                                class="hover:text-white transition-colors">Preguntas Frecuentes</a></li>
                        <li><a href="javascript:void(0)" onclick="showPolicy('contact')"
                                class="hover:text-white transition-colors">Contacto</a></li>
                    </ul>
                </div>

            </div>
            <div
                class="pt-8 border-t border-slate-800 flex flex-col md:flex-row justify-between items-center gap-6 text-[10px] font-bold uppercase tracking-[0.2em]">
                <p>&copy; 2025 NeuroLingua Elite. Built for the future of education.</p>

            </div>
        </div>
    </footer>

    <!-- MODAL POLÍTICAS -->
    <div id="policyModal"
        class="fixed inset-0 z-[500] bg-black/80 backdrop-blur-md hidden flex items-center justify-center p-6">
        <div class="bg-white rounded-[2.5rem] max-w-2xl w-full max-h-[80vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="p-8 border-b border-slate-100 flex justify-between items-center">
                <h3 id="policyTitle" class="text-2xl font-black italic"></h3>
                <button onclick="closePolicy()"
                    class="w-10 h-10 rounded-full hover:bg-slate-100 flex items-center justify-center transition-all"><i
                        class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div id="policyContent"
                class="p-10 overflow-y-auto custom-scrollbar text-slate-600 leading-relaxed text-sm"></div>
        </div>
    </div>

    <!-- MODAL API / SETTINGS (Auto-Generated) -->
    <div id="apiModal"
        class="fixed inset-0 z-[3000] bg-black/90 hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white rounded-[2rem] max-w-md w-full p-8 shadow-2xl border border-slate-100 relative">
            <button onclick="closeApiModal()"
                class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 w-12 h-12 flex items-center justify-center"><i
                    class="fa-solid fa-xmark text-xl"></i></button>

            <h3 id="apiModalTitle" class="text-2xl font-black text-slate-900 italic mb-2">Neural Link</h3>
            <p id="apiModalDesc" class="text-xs text-slate-500 font-medium mb-6">Configura tus credenciales y
                preferencias.</p>

            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Groq API
                        Key</label>
                    <input type="password" id="groqKeyInput"
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-[#78559b]/20 font-mono text-slate-600">
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Cerebras
                        API Key</label>
                    <input type="password" id="cerebrasKeyInput"
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-[#78559b]/20 font-mono text-slate-600">
                </div>

                <!-- Voice Settings -->
                <div class="pt-4 border-t border-slate-100">
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Voz en
                        Inglés (Tutor)</label>
                    <select id="enVoiceSelect"
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-[#78559b]/20"></select>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-2 tracking-widest">Voz en
                        Español (Traducción)</label>
                    <select id="esVoiceSelect"
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-[#78559b]/20"></select>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="saveApiKeys(); saveVoicePrefs();"
                        class="flex-1 bg-[#78559b] text-white py-3 rounded-xl font-bold text-xs uppercase tracking-widest hover:bg-slate-900 transition-all shadow-lg hover:shadow-xl active:scale-95">Guardar
                        Configuración</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PROMO POPUP -->
    <div id="promoPopup"
        class="fixed inset-0 z-[4000] bg-black/80 backdrop-blur-md hidden flex items-center justify-center p-6 animate-in fade-in duration-500">
        <div
            class="bg-white rounded-[2rem] max-w-lg w-full p-2 shadow-2xl relative border border-slate-100 transform transition-all scale-100">
            <button onclick="closePromoPopup()"
                class="absolute top-4 right-4 z-10 bg-white/50 hover:bg-white text-slate-800 w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-sm transition-all shadow-sm"><i
                    class="fa-solid fa-xmark"></i></button>

            <div class="rounded-[1.5rem] overflow-hidden relative group cursor-pointer" onclick="scrollToLab()">
                <img src="https://www.webcincodev.com/blog/wp-content/uploads/2026/01/ChatGPT-Image-1-ene-2026-12_44_35.png"
                    class="w-full h-auto object-cover group-hover:scale-105 transition-transform duration-700">
                <div
                    class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent p-8 pt-24 text-center">
                    <button onclick="event.stopPropagation(); scrollToLab()"
                        class="bg-[#78559b] text-white px-8 py-3 rounded-xl font-black uppercase text-xs tracking-[0.2em] shadow-lg shadow-[#78559b]/40 hover:scale-105 active:scale-95 transition-all">
                        Crear Escena ✨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CHAT VIEW -->
    <div id="chatView" class="fixed inset-0 z-[2000] hidden bg-white flex flex-col">
        <header
            class="h-auto min-h-24 border-b border-slate-100 px-4 py-4 flex flex-wrap items-center justify-between bg-white/80 backdrop-blur-md">
            <button onclick="closeChat()"
                class="text-slate-500 hover:text-[#78559b] font-black uppercase text-[10px] tracking-widest transition-colors"><i
                    class="fa-solid fa-arrow-left mr-3"></i> Volver al Panel</button>
            <h3 id="chatLevelTitle" class="text-slate-900 font-black text-xl italic tracking-tighter"></h3>
            <div class="flex flex-wrap gap-2 items-center justify-end w-full mt-2">
                <button id="diffBtn" onclick="toggleDifficulty()"
                    class="bg-emerald-100 text-emerald-600 px-4 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest border border-emerald-200 hover:scale-105 transition-all w-full md:w-28">
                    Beginner
                </button>

                <button onclick="promptCustomScene()"
                    class="bg-indigo-50 border border-indigo-100 px-5 py-2.5 rounded-xl text-indigo-600 font-bold text-[10px] uppercase tracking-wider hover:bg-white transition-all w-full md:w-auto">Crear
                    Escena</button>
                <button onclick="generateMission()"
                    class="bg-slate-50 border border-slate-200 px-5 py-2.5 rounded-xl text-slate-600 font-bold text-[10px] uppercase tracking-wider hover:bg-white transition-all w-full md:w-auto">Misión
                    IA</button>
                <button onclick="finishMission()"
                    class="bg-[#78559b] px-6 py-2.5 rounded-xl text-white font-black text-[10px] uppercase tracking-wider shadow-lg shadow-[#78559b]/20 hover:scale-105 transition-all w-full md:w-auto">Completar</button>
            </div>
        </header>

        <div class="flex-1 flex flex-col lg:flex-row max-w-[1600px] mx-auto w-full p-6 gap-8 overflow-hidden">
            <!-- Columna Central: Chat -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <div id="chatMessages" class="flex-1 overflow-y-auto space-y-8 pr-4 py-6 custom-scrollbar"></div>
                <div id="typingIndicator" class="hidden mb-6 ml-6 flex items-center gap-3">
                    <span class="custom-loader"></span>
                    <span class="text-[9px] font-black uppercase text-[#78559b] tracking-widest">Sincronizando
                        IA...</span>
                </div>
                <div id="quiz-container" class="hidden mt-6 p-6 bg-slate-50 rounded-2xl border border-slate-100">
                    <h3 class="text-xl font-black text-slate-900 italic mb-4">¡Es hora del Quiz!</h3>
                    <div id="quiz-questions" class="space-y-6">
                        <!-- Quiz questions will be rendered here -->
                    </div>
                    <button id="submit-quiz-btn"
                        class="mt-6 w-full py-3 bg-[#78559b] text-white font-black rounded-xl hover:bg-slate-800 transition-all shadow-lg shadow-[#78559b]/20 uppercase tracking-widest text-[10px]">
                        Enviar Respuestas
                    </button>
                    <div id="quiz-results" class="mt-4 hidden text-center text-sm font-medium">
                        <!-- Quiz results will be displayed here -->
                    </div>
                </div>
                <div class="mt-4 flex flex-col gap-4">
                    <div
                        class="flex gap-4 bg-slate-50 p-5 rounded-[2rem] border border-slate-100 shadow-inner focus-within:ring-2 focus-within:ring-[#78559b]/20 transition-all">
                        <button onclick="toggleVoiceInput()" id="micBtn"
                            class="text-slate-400 hover:text-rose-500 transition-colors"><i
                                class="fa-solid fa-microphone text-xl"></i></button>
                        <input type="text" id="userInput" placeholder="Responde en inglés..."
                            class="flex-1 bg-transparent px-2 outline-none text-slate-800 font-medium"
                            onkeypress="if(event.key==='Enter') sendMessage()">
                        <button onclick="sendMessage()"
                            class="bg-[#78559b] w-12 h-12 rounded-2xl text-white hover:bg-slate-800 transition-all flex items-center justify-center shadow-lg"><i
                                class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha: Inteligencia Neural -->
            <aside class="hidden lg:flex flex-col gap-6 lg:w-1/3 overflow-y-auto custom-scrollbar">
                <!-- Neural Glossary -->
                <div class="glass-card p-8 rounded-[2.5rem] flex flex-col h-1/2">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-slate-400">Glosario Neural
                        </h3>
                        <span id="vocabCount"
                            class="bg-[#78559b]/10 text-[#78559b] text-[9px] font-black px-2 py-0.5 rounded-full">0</span>
                    </div>
                    <div id="glossaryList" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
                        <p class="text-[11px] text-slate-400 italic text-center mt-10">Las neuronas detectarán palabras
                            nuevas...</p>
                    </div>
                </div>





                <!-- Grammar Insights -->
                <div class="glass-card p-8 rounded-[2.5rem] flex flex-col h-1/2">
                    <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-slate-400 mb-6">Grammar Insights
                    </h3>
                    <div id="grammarList" class="flex-1 overflow-y-auto space-y-4 pr-2 custom-scrollbar">
                        <p class="text-[11px] text-slate-400 italic text-center mt-10">Análisis gramatical en tiempo
                            real...</p>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        const apiKey = "";
        const PROGRESS_KEY = "neuro_lingua_progress_v5";
        const API_KEYS_KEY = "neuro_lingua_api_keys";
        let activeLevel = null;
        let messages = [];
        let glossary = [];
        let skills = { fluency: 20, grammar: 15, vocabulary: 10 };

        const topics = ["Social Intro", "Identity", "Workplace", "Emotions", "Food & Dining", "Travel", "Business", "Ethics", "Science", "Art", "Technology", "Health", "Politics", "Environment", "History", "Literature", "Music", "Cinema", "Sports", "Fashion"];
        const levels = Array.from({ length: 80 }, (_, i) => ({
            id: i + 1,
            title: `Level ${i + 1}: ${topics[i % topics.length]}`,
            description: `Cognitive training session focused on ${topics[i % topics.length]}.`
        }));

        const policies = {
            privacy: { title: "Privacidad de Datos", content: "<p class='mb-4'>Su información se procesa mediante los protocolos de seguridad de NeuroLingua.</p><p>Las sesiones de voz no se almacenan permanentemente.</p>" },
            terms: { title: "Términos de Uso", content: "<p>Al usar NeuroLingua usted acepta el método de inmersión total. El progreso es responsabilidad del alumno.</p>" },
            cookies: { title: "Cookies", content: "<p>Usamos almacenamiento local para guardar sus niveles desbloqueados.</p>" },
            help: {
                title: "Centro de Ayuda",
                content: `
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-bold text-slate-800 mb-2">¿Cómo accedo al curso?</h4>
                            <p>Una vez realizada la compra en Hotmart, recibirás un correo electrónico automático con tus datos de acceso a la plataforma.</p>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 mb-2">Requisitos Técnicos</h4>
                            <p>Para la mejor experiencia con nuestra IA de reconocimiento de voz, recomendamos usar <strong>Google Chrome</strong> o <strong>Microsoft Edge</strong> en una computadora de escritorio o laptop.</p>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 mb-2">Problemas de Acceso</h4>
                            <p>Si olvidaste tu contraseña, puedes restablecerla directamente desde la página de inicio de sesión de Hotmart.</p>
                        </div>
                    </div>`
            },
            faq: {
                title: "Preguntas Frecuentes",
                content: `
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-bold text-slate-800 mb-2">¿El pago es seguro?</h4>
                            <p>Sí, absolutamente. Todas las transacciones se procesan a través de <strong>Hotmart</strong>, la plataforma líder mundial en productos digitales, que garantiza la seguridad de tus datos bancarios.</p>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 mb-2">¿Tengo garantía?</h4>
                            <p>Ofrecemos una garantía incondicional de satisfacción de <strong>7 días</strong>. Si el curso no cumple tus expectativas, puedes solicitar el reembolso completo directamente en Hotmart.</p>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 mb-2">¿Recibiré un certificado?</h4>
                            <p>Sí. Al completar todos los niveles y misiones del curso, recibirás un certificado digital de finalización de <strong>NeuroLingua Elite</strong> que podrás añadir a tu LinkedIn.</p>
                        </div>
                         <div>
                            <h4 class="font-bold text-slate-800 mb-2">¿El acceso es de por vida?</h4>
                            <p>Sí, una vez adquirido el programa, tendrás acceso ilimitado a todas las lecciones y actualizaciones futuras de este curso.</p>
                        </div>
                    </div>`
            },
            contact: {
                title: "Contacto y Soporte",
                content: `
                    <div class="space-y-6">
                        <p>Estamos aquí para ayudarte en tu camino hacia la fluidez.</p>
                        <div class="bg-indigo-50 p-6 rounded-2xl border border-indigo-100">
                            <h4 class="font-bold text-indigo-900 mb-1">Soporte por Correo</h4>
                            <p class="text-indigo-600 mb-4">info@webcincodev.com</p>
                            <p class="text-xs text-indigo-400">Tiempo de respuesta estimado: 24 horas hábiles.</p>
                        </div>
                         <div>
                            <h4 class="font-bold text-slate-800 mb-2">Horario de Atención</h4>
                            <p>Lunes a Viernes: 9:00 AM - 6:00 PM (Hora de Colombia)</p>
                        </div>
                    </div>`
            }
        };

        function getProgress() {
            try {
                const s = localStorage.getItem(PROGRESS_KEY);
                return s ? JSON.parse(s) : [1];
            } catch (e) {
                console.error("Progress Load Error", e);
                return [1];
            }
        }

        function renderLevels() {
            const grid = document.getElementById('levelsGrid');
            if (!grid) return;
            const progress = getProgress();
            const max = Math.max(...progress);
            grid.innerHTML = levels.map(l => {
                const isLocked = l.id > max;
                return `
                    <div onclick="${isLocked ? '' : `startMission(${l.id})`}" class="snap-center shrink-0 w-80 glass-card p-8 rounded-[2rem] relative border-2 ${isLocked ? 'opacity-30 grayscale pointer-events-none' : 'cursor-pointer hover:border-[#78559b] border-slate-100'} transition-all hover:-translate-y-1">
                        <div class="flex justify-between items-start mb-6">
                            <h4 class="text-slate-900 font-black text-2xl italic tracking-tighter">#${l.id.toString().padStart(2, '0')}</h4>
                            ${!isLocked ? '<span class="w-3 h-3 rounded-full bg-[#78559b] animate-ping"></span>' : ''}
                        </div>
                        <h3 class="text-slate-800 font-black text-[12px] mb-2 uppercase tracking-wider">${l.title}</h3>
                        <p class="text-slate-400 text-[10px] font-medium mb-8 leading-relaxed line-clamp-2">${l.description}</p>
                        <span class="text-[10px] font-black uppercase text-[#78559b] italic tracking-widest">${isLocked ? 'Cerrado' : 'Entrar ✨'}</span>
                    </div>`;
            }).join('');
        }


        // Voice Logic - Robust Native with User Selection
        let currentUtterance = null;
        let selectedVoiceName = localStorage.getItem("neuro_selected_voice_en") || null;
        let availableVoices = [];
        let activeAudioId = null;
        // let preferredVoices = { en: null, es: null }; // Legacy kept if needed references exist, but logic replaced

        function initVoices() {
            availableVoices = window.speechSynthesis.getVoices();
            if (availableVoices.length > 0) {
                renderVoiceSelector();
            }
        }
        window.speechSynthesis.onvoiceschanged = initVoices;

        function renderVoiceSelector() {
            // Find or Create Selector in API Modal (or new Settings Modal)
            // For now, let's inject it into the Chat Header settings or prompt user
            // Let's console log for debugging first, but user needs UI.
            // We will auto-select the best one if no selection
            if (!selectedVoiceName) {
                const best = availableVoices.find(v => v.name.includes('Microsoft') && v.name.includes('Natural') && v.name.includes('English')) ||
                    availableVoices.find(v => v.name.includes('Google US English'));
                if (best) selectedVoiceName = best.name;
            }
        }

        // Voice Logic - Server Side Neural Proxy

        // Voice Logic - Client Side Native

        // Voice Logic - Server Side Neural Proxy (Node.js)
        let audioPlayer = new Audio();
        let isPlaying = false;

        async function speak(text, lang = 'en', btnId = null) {
            // STOP LOGIC
            // Stop Web Audio API Source
            if (activeAudioId === btnId && (isPlaying || window.speechSynthesis.speaking)) {
                if (window.currentSource) {
                    try { window.currentSource.stop(); } catch (e) { }
                    window.currentSource = null;
                }
                if (audioPlayer) { audioPlayer.pause(); audioPlayer.currentTime = 0; } // Legacy fallback
                window.speechSynthesis.cancel();
                isPlaying = false;
                activeAudioId = null;
                resetAllAudioIcons();
                return;
            }

            // Reset previous
            if (window.currentSource) {
                try { window.currentSource.stop(); } catch (e) { }
                window.currentSource = null;
            }
            window.speechSynthesis.cancel();
            resetAllAudioIcons();
            isPlaying = false;

            if (!text) return;

            if (btnId) {
                activeAudioId = btnId;
                setAudioLoading(btnId);
            }

            try {
                // 1. Try SERVER-SIDE Neural Voices (Edge TTS)
                // Defaulting to Female Voices (Aria/Dalia) as per user request
                let targetVoice = (lang === 'es') ? 'es-MX-DaliaNeural' : 'en-US-AriaNeural';

                console.log(`[Frontend] Requesting TTS: "${text.substring(0, 15)}..." [${lang}] Voice: ${targetVoice}`);

                const response = await fetch('/api/coqui_tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text,
                        voice: targetVoice
                    })
                });

                if (!response.ok) {
                    const errText = await response.text();
                    console.error("[Frontend] Server TTS Failed:", response.status, errText);
                    throw new Error("Edge TTS Failed: " + response.status);
                }

                console.log("[Frontend] TTS Response received. Decoding audio...");
                const arrayBuffer = await response.arrayBuffer();
                console.log(`[Frontend] Buffer size: ${arrayBuffer.byteLength} bytes`);

                // Inspect first few bytes (Is it JSON error? HTML?)
                const textPreview = new TextDecoder().decode(arrayBuffer.slice(0, 50));
                // console.log(`[Frontend] Buffer Header Preview: "${textPreview}"`);

                if (!window.audioCtx) {
                    window.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }

                // Decode
                const audioBufferEncoded = await window.audioCtx.decodeAudioData(arrayBuffer);

                // Stop any previous source if we tracked it (we track audioPlayer/activeAudioId)
                if (window.currentSource) {
                    try { window.currentSource.stop(); } catch (e) { }
                }

                const source = window.audioCtx.createBufferSource();
                window.currentSource = source; // Global tracking
                source.buffer = audioBufferEncoded;
                source.connect(window.audioCtx.destination);

                source.onended = () => {
                    console.log("[Frontend] Audio ended.");
                    isPlaying = false;
                    window.currentSource = null;
                    if (btnId) resetAudioIcon(btnId);
                    activeAudioId = null;
                };

                source.start(0);
                console.log("[Frontend] Audio started via Web Audio API");

                isPlaying = true;
                if (btnId) setAudioIconValid(btnId);

            } catch (e) {
                console.warn("[Frontend] Falling back to Browser TTS", e);
                fallbackSpeak(text, lang, btnId);
            }
        }



        function fallbackSpeak(text, lang, btnId) {
            if (!window.speechSynthesis) return;

            // Re-render reset icon first to remove spinner
            if (btnId) setAudioIconValid(btnId);

            const utter = new SpeechSynthesisUtterance(text);
            const voices = window.speechSynthesis.getVoices();

            let voice = null;

            if (lang === 'en') {
                // Female English Preference
                voice = voices.find(v => v.name.includes('Female') && v.lang.startsWith('en')) ||
                    voices.find(v => v.name.includes('Zira')) ||
                    voices.find(v => v.name.includes('Google US English'));
            } else {
                // Female Spanish Preference
                voice = voices.find(v => v.name.includes('Female') && v.lang.startsWith('es')) ||
                    voices.find(v => v.name.includes('Sabina')) ||
                    voices.find(v => v.name.includes('Google español'));
            }

            if (voice) {
                utter.voice = voice;
                console.log(`[Frontend] Fallback Voice: ${voice.name}`);
            }

            utter.lang = lang === 'en' ? 'en-US' : 'es-ES';
            utter.rate = 0.9;

            utter.onend = () => { resetAudioIcon(btnId); activeAudioId = null; };
            utter.onerror = () => { resetAudioIcon(btnId); activeAudioId = null; };

            window.speechSynthesis.speak(utter);
        }

        function setAudioLoading(btnId) {
            const btn = document.getElementById(btnId);
            if (btn) {
                const icon = btn.querySelector('i');
                if (icon) icon.className = "fa-solid fa-circle-notch fa-spin text-white";
            }
        }



        // Helpers for Audio UI state
        function setAudioIconValid(btnId) {
            const btn = document.getElementById(btnId);
            if (btn) {
                const icon = btn.querySelector('i');
                const span = btn.querySelector('span');
                if (icon) {
                    icon.className = "fa-solid fa-stop animate-pulse text-white";
                }
                if (span) span.innerText = "STOP";
                btn.classList.add('bg-rose-500', 'hover:bg-rose-600'); // Visual feedback for active state
                btn.classList.remove('bg-[#78559b]');
            }
        }

        function resetAudioIcon(btnId) {
            const btn = document.getElementById(btnId);
            if (btn) {
                const icon = btn.querySelector('i');
                const span = btn.querySelector('span');
                if (icon) {
                    if (btn.title && btn.title.includes('English')) {
                        icon.className = "fa-solid fa-volume-high text-[10px]";
                    } else {
                        icon.className = "fa-solid fa-ear-listen text-[10px]";
                    }
                }
                if (span) span.innerText = "LISTEN";
                btn.classList.remove('bg-rose-500', 'hover:bg-rose-600');
                btn.classList.add('bg-[#78559b]');
            }
        }

        function resetAllAudioIcons() {
            document.querySelectorAll('button[id^="btn-audio-"]').forEach(btn => resetAudioIcon(btn.id));
        }

        function getSavedKeys() {
            try {
                const s = localStorage.getItem(API_KEYS_KEY);
                return s ? JSON.parse(s) : { groq: "", cerebras: "" };
            } catch (e) {
                return { groq: "", cerebras: "" };
            }
        }

        async function callNeuralAPI(msgList) {
            const keys = getSavedKeys();
            if (!keys.groq && !keys.cerebras) {
                return { content: "Error: No has configurado tus accesos. Haz clic en 'Iniciar Sesión' para activarlas.", provider: "Local" };
            }

            const providers = [];
            if (keys.groq) providers.push({ name: "Groq", key: keys.groq, endpoint: "https://api.groq.com/openai/v1/chat/completions", model: "llama-3.3-70b-versatile" });
            if (keys.cerebras) providers.push({ name: "Cerebras", key: keys.cerebras, endpoint: "https://api.cerebras.ai/v1/chat/completions", model: "llama3.1-70b" });

            // Sort randomly to balance load
            providers.sort(() => Math.random() - 0.5);

            let lastError = null;

            for (const p of providers) {
                try {
                    console.log(`Intentando conexión neural via ${p.name}...`);
                    const response = await fetch(p.endpoint, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${p.key}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: p.model,
                            messages: msgList,
                            temperature: 0.6
                        })
                    });

                    if (!response.ok) {
                        const err = await response.text();
                        console.warn(`Nodo ${p.name} falló:`, err);
                        lastError = err;
                        continue; // Try next provider
                    }

                    const data = await response.json();
                    return { content: data.choices[0].message.content, provider: p.name };

                } catch (e) {
                    console.error(`Error crítico en nodo ${p.name}:`, e);
                    lastError = e.message;
                }
            }

            // If we reach here, all providers failed
            let errorMsg = "Error en la Conexión Neural.";
            if (window.location.protocol === 'file:') {
                errorMsg += " El navegador bloquea las peticiones desde archivos locales. Usa un servidor local (npx serve .).";
            } else {
                errorMsg += ` Detalle: ${lastError || "Revisa tus accesos"}.`;
            }
            return { content: errorMsg, provider: "Local" };
        }

        let difficulty = "Beginner"; // Default GLOBAL

        async function startMission(id) {
            activeLevel = levels.find(l => l.id === id);
            document.getElementById('chatLevelTitle').innerText = activeLevel.title;
            document.getElementById('chatMessages').innerHTML = "";
            document.getElementById('chatView').classList.remove('hidden');

            // Difficulty-based Nuances
            let diffInstruct = "";
            if (difficulty === "Beginner") {
                diffInstruct = "Level: BEGINNER. Speak slowly (simulated by simple words). Use basic vocabulary. Be very encouraging.";
            } else {
                diffInstruct = "Level: ADVANCED. Use idioms, phrasal verbs, and complex grammar. Speak naturally and fast. Be strict with corrections.";
            }

            const sysPrompt = `Act as a Professional English Tutor.
            CONTEXT: Level ${activeLevel.title}.
            ${diffInstruct}
            
            STRICT RULES:
            1. YOU MUST SPEAK ONLY IN ENGLISH in your main text response. Do not use Spanish there.
            2. You must provide the Spanish translation in the JSON block only.
            3. CRITICAL: Analyze user's input for grammar/pronunciation errors.
            4. SUGGESTIONS: Provide 3 short, natural responses the user could say next.
            
            OUTPUT FORMAT (JSON MUST BE AT THE END):
            [English Response Here]
            \`\`\`json
            {
              "translation": "Traducción exacta al español de tu respuesta en inglés",
              "correction": "Correct sentence if user failed, else null",
              "phonetics": "IPA pronunciation of the correction (e.g. /haʊ ɑːr juː/)",
              "pronunciation_tip": "Tip on how to sound native (in Spanish)",
              "suggested_replies": ["Option 1", "Option 2", "Option 3"],
              "vocabulary": [{"word": "string", "meaning": "string"}],
              "grammar_tips": ["string"]
            }
            \`\`\``;

            messages = [{ role: "system", content: sysPrompt }];

            // Saludo personalizado del asistente
            appendMsg('ai', "Hola. Soy tu Asistente Virtual. Estoy encantado de conocerte. Te ayudaré a aprender inglés. No te preocupes, hablaré lentamente y utilizaré palabras fáciles. Nos divertiremos aprendiendo juntos.");
            messages.push({ role: "assistant", content: "Hello. My name is Virtual Assistant. I am delighted to meet you. I will help you learn English. Don't worry, I will speak slowly and use easy words. We will have fun learning together." });

            // Trigger first AI message - CRITICAL FIX: Send SYSTEM PROMPT history
            document.getElementById('typingIndicator').classList.remove('hidden');

            // We append the user trigger to the history temporarily for the call, or just push it.
            // Let's push a hidden user trigger to start the convo contextually
            const startMsg = { role: "user", content: "Start the lesson now. Introduce yourself." };
            messages.push(startMsg);

            const res = await callNeuralAPI(messages);
            document.getElementById('typingIndicator').classList.add('hidden');
            processAIResponse(res.content);
        }

        function toggleDifficulty() {
            difficulty = difficulty === "Beginner" ? "Advanced" : "Beginner";
            const btn = document.getElementById('diffBtn');
            if (btn) {
                btn.innerText = difficulty;
                btn.className = difficulty === "Beginner"
                    ? "bg-emerald-100 text-emerald-600 px-4 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-widest border border-emerald-200"
                    : "bg-rose-100 text-rose-600 px-4 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-widest border border-rose-200";
            }
            alert(`Nivel cambiado a: ${difficulty}. Reinicia el reto para aplicar.`);
        }

        async function startCustomLab() {
            const input = document.getElementById('customSceneInput');
            const scene = input.value.trim();
            if (!scene) {
                alert("Por favor, describe un escenario para comenzar.");
                return;
            }

            activeLevel = { id: 0, title: `Custom Lab: ${scene}` };
            document.getElementById('chatLevelTitle').innerText = activeLevel.title;
            document.getElementById('chatMessages').innerHTML = "";
            document.getElementById('chatView').classList.remove('hidden');

            const sysPrompt = `You are a professional English tutor. Roleplay this CUSTOM scenario: ${scene}.
            TEACH and correct mistakes.
            
            CRITICAL: Start the conversation in character for this specific scenario.
            Return a JSON block with translation, correction, vocabulary, grammar_tips, and scores.`;

            messages = [{ role: "system", content: sysPrompt }];

            document.getElementById('typingIndicator').classList.remove('hidden');
            const res = await callNeuralAPI([{ role: "user", content: `Start the custom simulation: ${scene}` }]);
            document.getElementById('typingIndicator').classList.add('hidden');
            processAIResponse(res.content);
            input.value = "";
        }

        function closeChat() { document.getElementById('chatView').classList.add('hidden'); }

        function appendMsg(role, text, translation = "") {
            const c = document.getElementById('chatMessages');
            const d = document.createElement('div');
            d.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-4 duration-500`;
            const content = role === 'ai' ? marked.parse(text) : text;

            // Generate unique IDs for this message's buttons
            const msgId = Date.now();
            const btnIdEn = `btn-audio-en-${msgId}`;
            const btnIdEs = `btn-audio-trans-${msgId}`;

            const safeText = text.replace(/"/g, '&quot;');
            const safeTrans = translation.replace(/"/g, '&quot;');

            const bubbleStyle = role === 'user' ? 'bg-slate-900 text-white rounded-[1.8rem] rounded-tr-none' : 'bg-slate-50 text-slate-800 rounded-[1.8rem] rounded-tl-none border border-slate-100 markdown-body';

            d.innerHTML = `<div class="${bubbleStyle} px-7 py-5 max-w-[85%] shadow-sm leading-relaxed relative">
                <div class="flex justify-between items-start gap-4">
                    <div class="text-[15px] font-medium flex-1">${content}
                        ${translation ? `<div class="mt-4 pt-4 border-t border-[#78559b]/10 bg-gradient-to-r from-[#78559b]/5 to-transparent -mx-7 px-7 pb-2">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[9px] font-black uppercase text-[#78559b] tracking-widest block">Traducción Neural</span>
                            </div>
                            <p class="text-[14px] italic text-[#634483] font-bold leading-relaxed border-l-4 border-[#78559b] pl-4 py-1">${translation}</p>
                        </div>` : ''}
                    </div>
                    ${role === 'ai' ? `<button id="${btnIdEn}" data-text="${safeText}" onclick="speak(this.dataset.text, 'en', '${btnIdEn}')" class="text-white hover:bg-slate-800 transition-colors flex items-center gap-2 bg-[#78559b] px-3 py-3 rounded-full shadow-lg shadow-[#78559b]/20 hover:scale-105 active:scale-95 transition-all mt-1" title="Listen in English">
                        <i class="fa-solid fa-volume-high text-[10px]"></i>
                        <span class="text-[9px] font-black uppercase tracking-wider">Listen</span>
                    </button>` : ''}
                </div>`;
            c.appendChild(d);
            c.scrollTop = c.scrollHeight;
        }

        let recognition = null;
        let isRecording = false;

        function toggleVoiceInput() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("Tu navegador no soporta reconocimiento de voz. Usa Chrome o Edge.");
                return;
            }

            if (isRecording) {
                recognition.stop();
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US'; // English input for learning
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = () => {
                isRecording = true;
                const btn = document.getElementById('micBtn');
                btn.classList.add('text-rose-600', 'animate-pulse');
                btn.classList.remove('text-slate-400');
            };

            recognition.onend = () => {
                isRecording = false;
                const btn = document.getElementById('micBtn');
                btn.classList.remove('text-rose-600', 'animate-pulse');
                btn.classList.add('text-slate-400');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const input = document.getElementById('userInput');
                input.value = transcript;
                setTimeout(sendMessage, 500); // Auto-send for fluid flow
            };

            recognition.start();
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if (!text) return;
            appendMsg('user', text);
            input.value = "";
            messages.push({ role: "user", content: text });

            document.getElementById('typingIndicator').classList.remove('hidden');
            const res = await callNeuralAPI(messages);
            document.getElementById('typingIndicator').classList.add('hidden');

            processAIResponse(res.content);
        }

        function processAIResponse(raw) {
            let text = raw;
            let translation = "";
            let data = {};
            let jsonMatch = raw.match(/```json\s*([\s\S]*?)\s*```/);

            if (jsonMatch) {
                try {
                    data = JSON.parse(jsonMatch[1]);
                    text = raw.replace(jsonMatch[0], "").trim();
                    translation = data.translation || "";

                    if (data.vocabulary) updateGlossary(data.vocabulary);
                    if (data.grammar_tips) updateGrammarInsights(data.grammar_tips);
                } catch (e) { console.error("Neural Parse Error", e); }
            }

            if (data.correction) {
                const c = document.getElementById('chatMessages');
                const div = document.createElement('div');
                div.className = "flex justify-center mb-6 animate-in slide-in-from-top duration-700";
                div.innerHTML = `<div class="bg-rose-50 border border-rose-100 px-6 py-4 rounded-3xl flex items-start gap-4 shadow-sm max-w-full sm:max-w-md lg:max-w-lg">
                    <div class="mt-1 bg-rose-100 p-2 rounded-full"><i class="fa-solid fa-graduation-cap text-rose-500"></i></div>
                    <div>
                        <p class="text-[9px] font-black text-rose-400 uppercase tracking-widest mb-1">Corrección Elite</p>
                        <p class="text-sm font-bold text-slate-700 mb-2">${data.correction}</p>
                        ${data.phonetics ? `<div class="flex items-center gap-2 mb-1">
                            <i class="fa-solid fa-lips text-slate-300 text-xs"></i>
                            <span class="font-mono text-xs text-slate-500 bg-slate-100 px-2 py-0.5 rounded">${data.phonetics}</span>
                        </div>` : ''}
                        ${data.pronunciation_tip ? `<p class="text-xs text-slate-500 italic border-l-2 border-rose-200 pl-2 mt-2">💡 ${data.pronunciation_tip}</p>` : ''}
                    </div>
                </div>`;
                c.appendChild(div);
            }

            appendMsg('ai', text, translation);
            messages.push({ role: "assistant", content: raw });

            // Render Suggested Replies
            if (data.suggested_replies && data.suggested_replies.length > 0) {
                const c = document.getElementById('chatMessages');
                const div = document.createElement('div');
                div.className = "flex flex-wrap gap-2 justify-end mb-4 animate-in fade-in slide-in-from-bottom-2 duration-700 items-center pl-12";
                div.innerHTML = `
                        <span class="text-[9px] font-bold text-slate-300 uppercase mr-2">Sugerencias:</span>
                        ${data.suggested_replies.map(r =>
                    `<button onclick="document.getElementById('userInput').value = '${r.replace(/'/g, "\\'")}'; sendMessage()" 
                           class="px-4 py-2 bg-white hover:bg-[#78559b] hover:text-white border border-slate-200 hover:border-[#78559b] rounded-full text-[10px] font-medium text-slate-500 transition-all shadow-sm">
                           ${r}
                          </button>`
                ).join('')}`;
                c.appendChild(div);
                c.scrollTop = c.scrollHeight;
            }
        }

        function updateGlossary(words) {
            words.forEach(item => {
                if (!glossary.find(g => g.word === item.word)) {
                    glossary.unshift(item);
                    const div = document.createElement('div');
                    div.className = "p-4 bg-slate-50 rounded-2xl border border-slate-100 animate-in slide-in-from-right duration-500 hover:bg-white transition-all shadow-sm group";
                    div.innerHTML = `
                        <div class="font-black text-xs text-[#78559b] group-hover:scale-105 transition-transform">${item.word}</div>
                        <div class="text-[10px] text-slate-400 font-medium">${item.meaning}</div>
                    `;
                    document.getElementById('glossaryList').prepend(div);
                }
            });
            document.getElementById('vocabCount').innerText = glossary.length;
        }

        function updateGrammarInsights(tips) {
            tips.forEach(tip => {
                const div = document.createElement('div');
                div.className = "p-4 bg-[#634483]/5 rounded-2xl border border-[#78559b]/10 text-[11px] font-medium text-slate-600 animate-in slide-in-from-right duration-500";
                div.innerHTML = `
                    <div class="flex gap-3">
                        <i class="fa-solid fa-wand-magic-sparkles text-[#78559b] mt-1"></i>
                        <p>${tip}</p>
                    </div>
                `;
                document.getElementById('grammarList').prepend(div);
            });
        }

        function updateSkills(deltas) {
            // Placeholder: Sync with dashboard if needed
            console.log("Skill Progress Updated:", deltas);
        }

        async function generateMission(customPrompt = "") {
            document.getElementById('typingIndicator').classList.remove('hidden');
            const prompt = customPrompt ? `Change the scenario: ${customPrompt}` : "Generate a specific academic mission for this lesson (a specific objective to achieve).";
            const res = await callNeuralAPI([{ role: "user", content: prompt }]);
            document.getElementById('typingIndicator').classList.add('hidden');
            processAIResponse(res.content); // Use processAIResponse to get translation
        }

        function promptCustomScene() {
            const scene = prompt("¿Qué escenario quieres practicar? (ej: Entrevista en Starbucks, Emergencia en el aeropuerto, etc.)");
            if (scene) generateMission(scene);
        }

        function finishMission() {
            const progress = getProgress();
            if (!progress.includes(activeLevel.id + 1)) progress.push(activeLevel.id + 1);
            localStorage.setItem(PROGRESS_KEY, JSON.stringify(progress));
            closeChat();
            renderLevels();
        }

        function showPolicy(type) {
            const p = policies[type];
            document.getElementById('policyTitle').innerText = p.title;
            document.getElementById('policyContent').innerHTML = p.content;
            document.getElementById('policyModal').classList.remove('hidden');
        }
        function closePolicy() { document.getElementById('policyModal').classList.add('hidden'); }

        function openApiModal() {
            const keys = getSavedKeys();
            document.getElementById('groqKeyInput').value = keys.groq;
            document.getElementById('cerebrasKeyInput').value = keys.cerebras;
            document.getElementById('apiModal').classList.remove('hidden');
        }

        function closeApiModal() {
            document.getElementById('apiModal').classList.add('hidden');
        }

        function saveApiKeys() {
            const groq = document.getElementById('groqKeyInput').value.trim();
            const cerebras = document.getElementById('cerebrasKeyInput').value.trim();
            localStorage.setItem(API_KEYS_KEY, JSON.stringify({ groq, cerebras }));
            closeApiModal();
            closeApiModal();
            alert("Sincronización Neural Actualizada.");
        }



        // HERO GALLERY LOGIC
        function initHeroGallery() {
            const slides = document.querySelectorAll('.gallery-slide');
            let current = 0;
            if (slides.length < 2) return;
            setInterval(() => {
                slides[current].classList.remove('active');
                current = (current + 1) % slides.length;
                slides[current].classList.add('active');
                slides[current].classList.add('active');
            }, 6000);
        }



        // Promo Popup Logic
        function openPromoPopup() {
            setTimeout(() => {
                const p = document.getElementById('promoPopup');
                if (p) p.classList.remove('hidden');
            }, 1500);
        }
        function closePromoPopup() {
            const p = document.getElementById('promoPopup');
            if (p) p.classList.add('hidden');
        }
        function scrollToLab() {
            closePromoPopup();
            const el = document.getElementById('customLabSection');
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Focus input for immediate action
                setTimeout(() => {
                    const input = document.getElementById('customSceneInput');
                    if (input) input.focus();
                }, 800);
            }
        }

        window.onload = () => {
            console.log("NeuroLingua Elite Bootstrap Initiated...");

            initHeroGallery();

            // Show Promo Popup
            openPromoPopup();


            // Check protocol
            if (window.location.protocol === 'file:') {
                document.getElementById('protocol-warning').classList.remove('hidden');
            }

            try {
                renderLevels();
            } catch (e) {
                console.error("Bootstrap Failure:", e);
                alert("Error crítico al iniciar el Aula. Por favor contacta soporte.");
            }

            updateAuthUI();
        };

        function updateAuthUI() {
            const keys = getSavedKeys();
            const navBtn = document.getElementById('navAuthBtn');

            if (keys.groq || keys.cerebras) {
                // User is logged in
                if (navBtn) {
                    navBtn.innerText = "Cerrar Sesión";
                    navBtn.onclick = logout;
                    navBtn.classList.add('text-rose-500', 'hover:text-rose-600');
                    navBtn.classList.remove('text-slate-500', 'hover:text-[#78559b]');
                }
            } else {
                // User is not logged in / Setup needed
                if (navBtn) {
                    navBtn.innerText = "Iniciar Sesión";
                    navBtn.onclick = openApiModal;
                    navBtn.classList.remove('text-rose-500', 'hover:text-rose-600');
                    navBtn.classList.add('text-slate-500', 'hover:text-[#78559b]');
                }
                setTimeout(openApiModal, 1500);
            }
        }

        function logout() {
            if (confirm("¿Estás seguro de que quieres cerrar sesión y borrar tus credenciales locales?")) {
                localStorage.removeItem(API_KEYS_KEY);
                location.reload();
            }
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');

            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function () {
                    mobileMenu.classList.toggle('hidden');
                });
            }
        });
    </script>
</body>

</html>